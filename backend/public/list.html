<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Files Dashboard</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">JSON Files Manager</h1>
        <button class="btn btn-outline-danger" onclick="logout()">
          Logout
        </button>
      </div>

      <div class="mb-4">
        <div class="input-group">
          <input
            type="text"
            id="newFilename"
            class="form-control"
            placeholder="New filename (without .json)"
          />
          <button class="btn btn-primary" onclick="createNewFile()">
            Create New JSON File
          </button>
        </div>
      </div>

      <h2 class="mb-3">Available JSON Files:</h2>
      <div class="row" id="fileList"></div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        Swal.fire("Unauthorized", "You must log in first.", "error").then(
          () => {
            window.location.href = "/";
          }
        );
      }

      document.addEventListener("DOMContentLoaded", loadFiles);

      async function loadFiles() {
        try {
          const response = await fetch("/api/files", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!response.ok) throw new Error("Unauthorized");

          const files = await response.json();
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";

          files.forEach((file) => {
            const col = document.createElement("div");
            col.className = "col-md-3 mb-3";

            const card = document.createElement("div");
            card.className = "card h-100 shadow-sm";

            const cardBody = document.createElement("div");
            cardBody.className = "card-body d-flex flex-column";

            const title = document.createElement("h5");
            title.className = "card-title";
            title.textContent = file;

            const actions = document.createElement("div");
            actions.className = "mt-auto";

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-sm btn-outline-primary me-2";
            editBtn.textContent = "Edit";
            editBtn.onclick = () => editFile(file);

            const permissionBtn = document.createElement("button");
            permissionBtn.className = "btn btn-sm btn-outline-secondary me-2";
            permissionBtn.textContent = "Permissions";
            permissionBtn.onclick = () => editPermission(file);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-sm btn-outline-danger";
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = () => deleteFile(file);

            actions.appendChild(editBtn);
            actions.appendChild(permissionBtn);
            actions.appendChild(deleteBtn);

            cardBody.appendChild(title);
            cardBody.appendChild(actions);
            card.appendChild(cardBody);
            col.appendChild(card);
            fileList.appendChild(col);
          });
        } catch (error) {
          console.error("Error loading files:", error);
          Swal.fire(
            "Error",
            "Unauthorized or failed to load files",
            "error"
          ).then(() => logout());
        }
      }

      function editFile(filename) {
        window.location.href = `editor?file=${filename}`;
      }
      function editPermission(filename) {
        window.location.href = `editor_permission?file=${filename}`;
      }

      async function deleteFile(filename) {
        const result = await Swal.fire({
          title: `Delete ${filename}.json?`,
          text: "This will remove both the file and its permissions.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, delete it!",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          const response = await fetch(`/api/create/${filename}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });

          if (response.ok) {
            await Swal.fire(
              "Deleted!",
              `${filename}.json has been removed.`,
              "success"
            );
            loadFiles();
          } else {
            throw new Error("Failed to delete file");
          }
        } catch (error) {
          console.error("Error deleting file:", error);
          Swal.fire("Error", "Failed to delete file", "error");
        }
      }

      async function createNewFile() {
        const filenameInput = document.getElementById("newFilename");
        const filename = filenameInput.value.trim();

        if (!filename) {
          Swal.fire("Invalid input", "Please enter a filename", "warning");
          return;
        }

        try {
          const response = await fetch(`/api/create/${filename}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({}),
          });

          if (response.ok) {
            const { filename: createdName } = await response.json();
            await Swal.fire(
              "Success",
              `${createdName}.json created successfully`,
              "success"
            );
            filenameInput.value = "";
            loadFiles();
          } else {
            throw new Error("Failed to create file");
          }
        } catch (error) {
          console.error("Error creating file:", error);
          Swal.fire("Error", "Failed to create file", "error");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/";
      }
    </script>

    <script src="js/bootstrap.bundle.min.js"></script>
  </body>
</html>
