<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Files Dashboard</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">JSON Files Manager</h1>
        <button class="btn btn-outline-danger" onclick="logout()">
          Logout
        </button>
      </div>

      <div class="mb-4">
        <div class="input-group">
          <input
            type="text"
            id="newFilename"
            class="form-control"
            placeholder="New filename (without .json)"
          />
          <button class="btn btn-primary" onclick="createNewFile()">
            Create New JSON File
          </button>
        </div>
      </div>

      <h2 class="mb-3">Available JSON Files:</h2>
      <div class="row" id="fileList"></div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        alert("You must log in first.");
        window.location.href = "/";
      }

      document.addEventListener("DOMContentLoaded", loadFiles);

      async function loadFiles() {
        try {
          const response = await fetch("/api/files", {
            headers: {
              Authorization: "Bearer " + token,
            },
          });
          if (!response.ok) throw new Error("Unauthorized");

          const files = await response.json();
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";

          files.forEach((file) => {
            const col = document.createElement("div");
            col.className = "col-md-4 mb-3";

            const card = document.createElement("div");
            card.className = "card h-100 shadow-sm";

            const cardBody = document.createElement("div");
            cardBody.className = "card-body d-flex flex-column";

            const title = document.createElement("h5");
            title.className = "card-title";
            title.textContent = file;

            const actions = document.createElement("div");
            actions.className = "mt-auto";

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-sm btn-outline-primary me-2";
            editBtn.textContent = "Edit";
            editBtn.onclick = () => editFile(file);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-sm btn-outline-danger";
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = () => deleteFile(file);

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            cardBody.appendChild(title);
            cardBody.appendChild(actions);
            card.appendChild(cardBody);
            col.appendChild(card);
            fileList.appendChild(col);
          });
        } catch (error) {
          console.error("Error loading files:", error);
          alert("Unauthorized or failed to load files");
          logout();
        }
      }

      function editFile(filename) {
        window.location.href = `editor?file=${filename}`;
      }

      async function deleteFile(filename) {
        if (confirm(`Are you sure you want to delete ${filename}.json?`)) {
          try {
            const response = await fetch(`/api/files/${filename}`, {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + token,
              },
            });
            if (response.ok) {
              alert("File deleted successfully");
              loadFiles();
            } else {
              throw new Error("Failed to delete file");
            }
          } catch (error) {
            console.error("Error deleting file:", error);
            alert("Failed to delete file");
          }
        }
      }

      async function createNewFile() {
        const filenameInput = document.getElementById("newFilename");
        const filename = filenameInput.value.trim();

        if (!filename) {
          alert("Please enter a filename");
          return;
        }

        try {
          const response = await fetch(`/api/files/${filename}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({}),
          });

          if (response.ok) {
            alert(`File ${filename}.json created successfully`);
            filenameInput.value = "";
            loadFiles();
          } else {
            throw new Error("Failed to create file");
          }
        } catch (error) {
          console.error("Error creating file:", error);
          alert("Failed to create file");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/";
      }
    </script>

    <script src="js/bootstrap.bundle.min.js"></script>
  </body>
</html>
