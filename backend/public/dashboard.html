<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jsoneditor@9.5.1/dist/jsoneditor.min.css"
    />

    <style>
      .editor-container {
        height: 70vh;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 20px;
      }
      .path-header {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .action-buttons .btn {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-md-12">
          <div
            class="d-flex justify-content-between align-items-center path-header"
          >
            <div>
              <h2 id="path-title">Loading...</h2>
              <p class="text-muted mb-0" id="path-url"></p>
            </div>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="saveData()">
                <i class="bi bi-save"></i> Save
              </button>
              <button class="btn btn-success" onclick="addField()">
                <i class="bi bi-plus-circle"></i> Add Field
              </button>
              <button class="btn btn-danger" onclick="deletePath()">
                <i class="bi bi-trash"></i> Delete Path
              </button>
              <a href="index.html" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
              </a>
            </div>
          </div>

          <div
            class="alert alert-info"
            id="status-message"
            style="display: none"
          ></div>

          <div class="editor-container" id="jsoneditor"></div>

          <div class="mt-3">
            <small class="text-muted">
              Double-click to edit values. Right-click for more options.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- JSON Editor -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.5.1/dist/jsoneditor.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>
    <script src="db.js"></script>

    <script>
      const params = new URLSearchParams(window.location.search);
      const pathName = params.get("path");
      const db = new RealtimeDB("ws://localhost:8008");
      let editor;

      document.getElementById(
        "path-title"
      ).textContent = `Editing: ${pathName}`;
      document.getElementById("path-url").textContent = `Path: ${pathName}`;

      // Initialize JSON Editor with better options
      const container = document.getElementById("jsoneditor");
      const options = {
        mode: "tree",
        modes: ["tree", "form", "code", "text"],
        search: true,
        history: true,
        onChange: function () {
          showStatus("You have unsaved changes", "warning");
        },
        onValidationError: function (errors) {
          showStatus(`Validation error: ${errors[0].message}`, "danger");
        },
      };

      editor = new JSONEditor(container, options);

      // Load initial data with error handling
      function loadData() {
        showStatus("Loading data...", "info");
        console.log(pathName);
        db.get(pathName, (data) => {
          console.log("Initial data loaded:", data);
          try {
            if (data && typeof data === "object") {
              editor.set(data); // ⬅️ tambahkan ini
              showStatus("Data loaded successfully", "success");
            } else {
              editor.set({}); // fallback jika tidak ada data
              showStatus("No data found - created empty object", "info");
            }
          } catch (e) {
            console.error("Error loading data:", e);
            showStatus("Error loading data. Invalid JSON format.", "danger");
          }
        });
      }
      db.on(pathName, (data) => {
        console.log("Update received:", data);
        loadData();
      });
      // Show status message
      function showStatus(message, type) {
        const statusEl = document.getElementById("status-message");
        statusEl.textContent = message;
        statusEl.className = `alert alert-${type}`;
        statusEl.style.display = "block";

        if (type !== "warning") {
          setTimeout(() => {
            statusEl.style.display = "none";
          }, 5000);
        }
      }

      // Save data to server
      function saveData() {
        try {
          const updatedData = editor.get();

          console.log(updatedData);
          db.delete(pathName);
          db.set(pathName, updatedData);

          showStatus("Data saved successfully!", "success");
        } catch (e) {
          console.error("Error saving data:", e);
          showStatus("Error saving data: " + e.message, "danger");
        }
      }

      // Delete path
      function deletePath() {
        //   db.delete(pathName);
        //  window.location.reload();
        // Handle delete confirmation
      }

      // Add new field
      function addField() {
        const key = prompt("Enter field name (key):");
        if (key) {
          const value = prompt("Enter field value (leave empty for null):");
          let parsedValue;

          try {
            parsedValue = value ? JSON.parse(value) : null;
          } catch {
            parsedValue = value; // Use as string if not valid JSON
          }

          const currentData = editor.get() || {};
          currentData[key] = parsedValue;
          editor.set(currentData);
          showStatus(`Added field: ${key}`, "success");
        }
      }

      // Initial load
      loadData();
    </script>
  </body>
</html>
